name: MLOps - Entrenamiento y ValidaciÃ³n

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'deteccionarritmias.py'
      - 'requirements-api.txt'
  pull_request:
    branches: [main]
  schedule:
    # Reentrenamiento semanal (domingos a las 2 AM)
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

jobs:
  train-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-api.txt
    
    - name: ğŸ” Verificar datos MIT-BIH
      run: |
        if [ ! -d "mit-bih" ]; then
          echo "âš ï¸  Datos MIT-BIH no encontrados"
          echo "   Descarga manual requerida"
          exit 1
        fi
        echo "âœ… Datos MIT-BIH encontrados"
    
    - name: ğŸ§ª Ejecutar tests (si existen)
      run: |
        if [ -f "tests/test_model.py" ]; then
          pytest tests/ -v
        else
          echo "â„¹ï¸  No hay tests definidos aÃºn"
        fi
      continue-on-error: true
    
    - name: ğŸš€ Entrenar modelo
      run: |
        echo "ğŸ”¬ Iniciando entrenamiento con MLflow..."
        python deteccionarritmias.py
    
    - name: ğŸ“Š Extraer mÃ©tricas de MLflow
      run: |
        python -c "
        import mlflow
        import json
        
        mlflow.set_tracking_uri('file:./mlruns')
        experiment = mlflow.get_experiment_by_name('deteccion_arritmias_ecg')
        
        if experiment:
            runs = mlflow.search_runs(experiment_ids=[experiment.experiment_id], max_results=1)
            if not runs.empty:
                metrics = runs.iloc[0].to_dict()
                
                # Extraer mÃ©tricas clave
                key_metrics = {
                    'accuracy': metrics.get('metrics.test_accuracy', 0),
                    'precision_V': metrics.get('metrics.test_precision_V', 0),
                    'recall_V': metrics.get('metrics.test_recall_V', 0),
                    'f1_V': metrics.get('metrics.test_f1_V', 0)
                }
                
                print('ğŸ“ˆ MÃ©tricas del modelo:')
                for k, v in key_metrics.items():
                    print(f'   {k}: {v:.4f}')
                
                # Guardar para steps siguientes
                with open('metrics.json', 'w') as f:
                    json.dump(key_metrics, f)
        "
    
    - name: âœ… Validar mÃ©tricas mÃ­nimas
      run: |
        python -c "
        import json
        import sys
        
        with open('metrics.json') as f:
            metrics = json.load(f)
        
        # Umbrales mÃ­nimos
        min_accuracy = 0.80
        min_precision_V = 0.75
        min_recall_V = 0.75
        
        passed = True
        
        if metrics['accuracy'] < min_accuracy:
            print(f'âŒ Accuracy muy baja: {metrics[\"accuracy\"]:.4f} < {min_accuracy}')
            passed = False
        
        if metrics['precision_V'] < min_precision_V:
            print(f'âŒ Precision muy baja: {metrics[\"precision_V\"]:.4f} < {min_precision_V}')
            passed = False
        
        if metrics['recall_V'] < min_recall_V:
            print(f'âŒ Recall muy bajo: {metrics[\"recall_V\"]:.4f} < {min_recall_V}')
            passed = False
        
        if passed:
            print('âœ… Todas las mÃ©tricas superan los umbrales mÃ­nimos')
            sys.exit(0)
        else:
            print('âš ï¸  Modelo no cumple con mÃ©tricas mÃ­nimas')
            sys.exit(1)
        "
    
    - name: ğŸ“¦ Archivar modelo y artefactos
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: trained-model-${{ github.sha }}
        path: |
          models/ecg_nv_cnn/model_v7.keras
          models/ecg_nv_cnn/meta_v7.json
          models/ecg_nv_cnn/history_v7.csv
          mlruns/
        retention-days: 30
    
    - name: ğŸ’¬ Comentar en PR (si aplica)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const metrics = JSON.parse(fs.readFileSync('metrics.json', 'utf8'));
          
          const comment = `## ğŸ¤– Resultados del Entrenamiento
          
          | MÃ©trica | Valor |
          |---------|-------|
          | Accuracy | ${metrics.accuracy.toFixed(4)} |
          | Precision (V) | ${metrics.precision_V.toFixed(4)} |
          | Recall (V) | ${metrics.recall_V.toFixed(4)} |
          | F1 (V) | ${metrics.f1_V.toFixed(4)} |
          
          âœ… Modelo entrenado y validado exitosamente.
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: ğŸ”” Notificar fallo
      if: failure()
      run: |
        echo "âŒ El entrenamiento o validaciÃ³n fallÃ³"
        echo "   Revisa los logs para mÃ¡s detalles"
