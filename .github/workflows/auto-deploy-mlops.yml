name: MLOps - Auto Deploy to Hugging Face

# Solo ejecuci√≥n MANUAL (sin entrenamiento autom√°tico)
# Los datos MIT-BIH no est√°n en GitHub
on:
  workflow_dispatch:  # Permitir ejecuci√≥n manual desde GitHub UI

jobs:
  train-validate-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ============================================
    # 1. PREPARACI√ìN
    # ============================================
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Historial completo para Git
        lfs: true       # Git LFS para modelos grandes
    
    - name: üêç Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: üì¶ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-api.txt
        echo "‚úÖ Dependencias instaladas"
    
    # ============================================
    # 2. ENTRENAMIENTO CON MLFLOW
    # ============================================
    - name: üß† Entrenar modelo con MLflow
      run: |
        echo "üöÄ Iniciando entrenamiento..."
        python deteccionarritmias.py
        echo "‚úÖ Entrenamiento completado"
    
    # ============================================
    # 3. SELECCI√ìN DEL MEJOR MODELO
    # ============================================
    - name: üèÜ Seleccionar mejor modelo de MLflow
      id: select_model
      run: |
        echo "üîç Buscando mejor modelo en MLflow..."
        python copy_best_model.py
        
        # Leer m√©tricas del modelo seleccionado
        if [ -f .mlflow_deploy_metrics.json ]; then
          F1_V=$(python -c "import json; print(json.load(open('.mlflow_deploy_metrics.json'))['f1_v'])")
          ACCURACY=$(python -c "import json; print(json.load(open('.mlflow_deploy_metrics.json'))['accuracy'])")
          PRECISION_V=$(python -c "import json; print(json.load(open('.mlflow_deploy_metrics.json'))['precision_v'])")
          RECALL_V=$(python -c "import json; print(json.load(open('.mlflow_deploy_metrics.json'))['recall_v'])")
          
          echo "f1_v=$F1_V" >> $GITHUB_OUTPUT
          echo "accuracy=$ACCURACY" >> $GITHUB_OUTPUT
          echo "precision_v=$PRECISION_V" >> $GITHUB_OUTPUT
          echo "recall_v=$RECALL_V" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Modelo seleccionado:"
          echo "   F1-Score V:  $F1_V"
          echo "   Precision V: $PRECISION_V"
          echo "   Recall V:    $RECALL_V"
          echo "   Accuracy:    $ACCURACY"
        else
          echo "‚ùå Error: No se pudo seleccionar modelo"
          exit 1
        fi
    
    # ============================================
    # 4. VALIDACI√ìN DE M√âTRICAS
    # ============================================
    - name: ‚úÖ Validar m√©tricas m√≠nimas
      run: |
        F1_V=${{ steps.select_model.outputs.f1_v }}
        ACCURACY=${{ steps.select_model.outputs.accuracy }}
        
        echo "üìä Validando m√©tricas del modelo..."
        
        # Umbrales m√≠nimos (ajusta seg√∫n tus necesidades)
        MIN_F1_V=0.70
        MIN_ACCURACY=0.90
        
        if (( $(echo "$F1_V < $MIN_F1_V" | bc -l) )); then
          echo "‚ùå F1-Score V ($F1_V) < m√≠nimo ($MIN_F1_V)"
          exit 1
        fi
        
        if (( $(echo "$ACCURACY < $MIN_ACCURACY" | bc -l) )); then
          echo "‚ùå Accuracy ($ACCURACY) < m√≠nimo ($MIN_ACCURACY)"
          exit 1
        fi
        
        echo "‚úÖ M√©tricas aprobadas para producci√≥n"
    
    # ============================================
    # 5. PREPARAR ARCHIVOS PARA HUGGING FACE
    # ============================================
    - name: üì¶ Preparar archivos para HF
      run: |
        echo "üìù Copiando archivos para Hugging Face..."
        cp README_HF.md README.md
        cp Dockerfile.hf Dockerfile
        echo "‚úÖ Archivos preparados"
    
    # ============================================
    # 6. CONFIGURAR GIT PARA DEPLOYMENT
    # ============================================
    - name: üîê Configurar credenciales de HF
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "MLOps Bot"
        
        # Configurar token de Hugging Face (desde Secrets)
        git remote add hf https://GustavoAdolf:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/GustavoAdolf/ProjectDetecArrit || true
    
    # ============================================
    # 7. DEPLOYMENT A HUGGING FACE
    # ============================================
    - name: üöÄ Deploy a Hugging Face Spaces
      run: |
        F1_V=${{ steps.select_model.outputs.f1_v }}
        ACCURACY=${{ steps.select_model.outputs.accuracy }}
        
        echo "üì§ Desplegando a Hugging Face..."
        
        # Agregar archivos modificados
        git add models/ecg_nv_cnn/model_v7.keras
        git add README.md
        git add Dockerfile
        
        # Commit con m√©tricas
        COMMIT_MSG="ü§ñ Auto-deploy: MLflow model (F1-V: $F1_V, Acc: $ACCURACY)"
        git commit -m "$COMMIT_MSG" || echo "Sin cambios para commit"
        
        # Push a Hugging Face
        git push hf HEAD:main --force
        
        echo "‚úÖ Deployment completado"
        echo "üîó Space: https://huggingface.co/spaces/GustavoAdolf/ProjectDetecArrit"
    
    # ============================================
    # 8. NOTIFICACI√ìN DE RESULTADO
    # ============================================
    - name: üì¢ Resumen del deployment
      if: success()
      run: |
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë  ‚úÖ DEPLOYMENT EXITOSO                ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "üìä Modelo desplegado:"
        echo "   F1-Score V:  ${{ steps.select_model.outputs.f1_v }}"
        echo "   Precision V: ${{ steps.select_model.outputs.precision_v }}"
        echo "   Recall V:    ${{ steps.select_model.outputs.recall_v }}"
        echo "   Accuracy:    ${{ steps.select_model.outputs.accuracy }}"
        echo ""
        echo "üîó URLs:"
        echo "   Space: https://huggingface.co/spaces/GustavoAdolf/ProjectDetecArrit"
        echo "   API: https://gustavoadolf-projectdetecarrit.hf.space"
        echo ""
        echo "‚è≥ El build en HF puede tardar 5-10 minutos"
    
    - name: ‚ùå Notificar fallo
      if: failure()
      run: |
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë  ‚ùå DEPLOYMENT FALL√ì                  ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "Revisa los logs arriba para m√°s detalles"
